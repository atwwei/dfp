import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { Subject, timer } from 'rxjs';
import { buffer, filter, map, switchMap } from 'rxjs/operators';
import { GPT_SOURCE, DELAY_TIME } from './consts';
import { ImpressionViewableEvent, SlotOnloadEvent, SlotRenderEndedEvent, SlotRequestedEvent, SlotResponseReceived, SlotVisibilityChangedEvent, } from './events';
import { DfpAdDisplay, DfpAdRefresh } from './actions';
import * as i0 from "@angular/core";
export class DfpService {
    constructor(platformId, document) {
        this.platformId = platformId;
        this.document = document;
        this.$queue = new Subject();
        this.$events = new Subject();
        if (isPlatformBrowser(this.platformId)) {
            this.initializeGPT();
            this.startActionQueue();
            this.addEventListeners();
        }
    }
    get events() {
        return this.$events.asObservable();
    }
    initializeGPT() {
        this.appendScript({ async: true, src: GPT_SOURCE });
        window.googletag = window.googletag || { cmd: [] };
    }
    startActionQueue() {
        const displaySlots = [];
        this.$queue
            .pipe(filter((act) => {
            if (act instanceof DfpAdDisplay) {
                displaySlots.push(act.slot);
                return false;
            }
            return (act instanceof DfpAdRefresh && displaySlots.indexOf(act.slot) === -1);
        }), map((act) => act.slot), buffer(this.$queue.pipe(switchMap(() => timer(DELAY_TIME * 2)))))
            .subscribe((refreshSlots) => {
            displaySlots.forEach((slot) => {
                googletag.display(slot);
            });
            displaySlots.splice(0);
            if (refreshSlots.length > 0) {
                googletag.pubads().refresh(refreshSlots);
            }
        });
    }
    addEventListeners() {
        googletag.cmd.push(() => {
            const pubads = googletag.pubads();
            pubads.addEventListener('impressionViewable', (event) => {
                this.$events.next(new ImpressionViewableEvent(event));
            });
            pubads.addEventListener('slotOnload', (event) => {
                this.$events.next(new SlotOnloadEvent(event));
            });
            pubads.addEventListener('slotRenderEnded', (event) => {
                this.$events.next(new SlotRenderEndedEvent(event));
            });
            pubads.addEventListener('slotRequested', (event) => {
                this.$events.next(new SlotRequestedEvent(event));
            });
            pubads.addEventListener('slotResponseReceived', (event) => {
                this.$events.next(new SlotResponseReceived(event));
            });
            pubads.addEventListener('slotVisibilityChanged', (event) => {
                this.$events.next(new SlotVisibilityChangedEvent(event));
            });
        });
    }
    clear(elementIds) {
        this.cmd(() => {
            googletag.pubads().clear(this.getSlots(elementIds));
        });
    }
    cmd(callback) {
        if (isPlatformBrowser(this.platformId)) {
            googletag.cmd.push(callback);
        }
    }
    destroySlots(elementIds) {
        this.cmd(() => {
            googletag.destroySlots(this.getSlots(elementIds));
        });
    }
    getSlots(elementIds) {
        let slots = undefined;
        if (isPlatformBrowser(this.platformId)) {
            if (googletag.apiReady && elementIds) {
                return googletag
                    .pubads()
                    .getSlots()
                    .filter((slot) => {
                    return elementIds.indexOf(slot.getSlotElementId()) !== -1;
                });
            }
        }
        return slots;
    }
    refresh(elementIds, opt_options) {
        this.cmd(() => {
            googletag.pubads().refresh(this.getSlots(elementIds), opt_options);
        });
    }
    queue(event) {
        this.$queue.next(event);
    }
    /**
     * Append Script tag to parentNode
     * @param options
     * @param parentNode The default setting is document.head
     * @returns
     */
    appendScript(options, parentNode) {
        parentNode = parentNode || this.document.head;
        const oldScript = options.id
            ? parentNode.querySelector('#' + options.id)
            : null;
        const script = this.document.createElement('script');
        Object.assign(script, options, {
            type: 'text/javascript',
        });
        if (oldScript) {
            parentNode.replaceChild(script, oldScript);
        }
        else {
            this.appendText('\n', parentNode);
            parentNode.appendChild(script);
            this.appendText('\n', parentNode);
        }
        return script;
    }
    appendText(data, parentNode) {
        parentNode = parentNode || this.document.head;
        const text = this.document.createTextNode(data);
        parentNode.appendChild(text);
        return text;
    }
}
DfpService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.1.1", ngImport: i0, type: DfpService, deps: [{ token: PLATFORM_ID }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
DfpService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.1.1", ngImport: i0, type: DfpService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.1.1", ngImport: i0, type: DfpService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGZwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2RmcC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFaEUsT0FBTyxFQUFjLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhFLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2xELE9BQU8sRUFFTCx1QkFBdUIsRUFDdkIsZUFBZSxFQUNmLG9CQUFvQixFQUNwQixrQkFBa0IsRUFDbEIsb0JBQW9CLEVBQ3BCLDBCQUEwQixHQUMzQixNQUFNLFVBQVUsQ0FBQztBQUNsQixPQUFPLEVBQVUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLFdBQVcsQ0FBQzs7QUFNL0QsTUFBTSxPQUFPLFVBQVU7SUFRckIsWUFDK0IsVUFBbUMsRUFDdEMsUUFBa0I7UUFEZixlQUFVLEdBQVYsVUFBVSxDQUF5QjtRQUN0QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBVHRDLFdBQU0sR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBRS9CLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBUyxDQUFDO1FBU3JDLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ3RDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztTQUMxQjtJQUNI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QWlCO1NBQ3hCLENBQUMsQ0FBQztRQUNILElBQUksU0FBUyxFQUFFO1lBQ2IsVUFBVSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7U0FDNUM7YUFBTTtZQUNMLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBQ2xDLFVBQVUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDbkM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsVUFBVSxDQUFDLElBQVksRUFBRSxVQUFvQjtRQUMzQyxVQUFVLEdBQUcsVUFBVSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQzlDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hELFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzt1R0EzSlUsVUFBVSxrQkFTWCxXQUFXLGFBQ1gsUUFBUTsyR0FWUCxVQUFVLGNBRlQsTUFBTTsyRkFFUCxVQUFVO2tCQUh0QixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7MEJBVUksTUFBTTsyQkFBQyxXQUFXOzhCQUNpQixRQUFROzBCQUEzQyxNQUFNOzJCQUFDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET0NVTUVOVCwgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCB0aW1lciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgYnVmZmVyLCBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBHUFRfU09VUkNFLCBERUxBWV9USU1FIH0gZnJvbSAnLi9jb25zdHMnO1xuaW1wb3J0IHtcbiAgRXZlbnQsXG4gIEltcHJlc3Npb25WaWV3YWJsZUV2ZW50LFxuICBTbG90T25sb2FkRXZlbnQsXG4gIFNsb3RSZW5kZXJFbmRlZEV2ZW50LFxuICBTbG90UmVxdWVzdGVkRXZlbnQsXG4gIFNsb3RSZXNwb25zZVJlY2VpdmVkLFxuICBTbG90VmlzaWJpbGl0eUNoYW5nZWRFdmVudCxcbn0gZnJvbSAnLi9ldmVudHMnO1xuaW1wb3J0IHsgQWN0aW9uLCBEZnBBZERpc3BsYXksIERmcEFkUmVmcmVzaCB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBTY3JpcHRPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBEZnBTZXJ2aWNlIHtcbiAgcHJpdmF0ZSAkcXVldWUgPSBuZXcgU3ViamVjdDxBY3Rpb24+KCk7XG5cbiAgcHJpdmF0ZSAkZXZlbnRzID0gbmV3IFN1YmplY3Q8RXZlbnQ+KCk7XG4gIGdldCBldmVudHMoKTogT2JzZXJ2YWJsZTxFdmVudD4ge1xuICAgIHJldHVybiB0aGlzLiRldmVudHMuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50LFxuICApIHtcbiAgICBpZiAoaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgdGhpcy5pbml0aWFsaXplR1BUKCk7XG4gICAgICB0aGlzLnN0YXJ0QWN0aW9uUXVldWUoKTtcbiAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRpYWxpemVHUFQoKSB7XG4gICAgdGhpcy5hcHBlbmRTY3JpcHQoeyBhc3luYzogdHJ1ZSwgc3JjOiBHUFRfU09VUkNFIH0pO1xuICAgIHdpbmRvdy5nb29nbGV0YWcgPSB3aW5kb3cuZ29vZ2xldGFnIHx8IHsgY21kOiBbXSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzdGFydEFjdGlvblF1ZXVlKCkge1xuICAgIGNvbnN0IGRpc3BsYXlTbG90czogZ29vZ2xldGFnLlNsb3RbXSA9IFtdO1xuXG4gICAgdGhpcy4kcXVldWVcbiAgICAgIC5waXBlKFxuICAgICAgICBmaWx0ZXIoKGFjdCkgPT4ge1xuICAgICAgICAgIGlmIChhY3QgaW5zdGFuY2VvZiBEZnBBZERpc3BsYXkpIHtcbiAgICAgICAgICAgIGRpc3BsYXlTbG90cy5wdXNoKGFjdC5zbG90KTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIGFjdCBpbnN0YW5jZW9mIERmcEFkUmVmcmVzaCAmJiBkaXNwbGF5U2xvdHMuaW5kZXhPZihhY3Quc2xvdCkgPT09IC0xXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgIG1hcCgoYWN0KSA9PiBhY3Quc2xvdCksXG4gICAgICAgIGJ1ZmZlcih0aGlzLiRxdWV1ZS5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aW1lcihERUxBWV9USU1FICogMikpKSksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChyZWZyZXNoU2xvdHMpID0+IHtcbiAgICAgICAgZGlzcGxheVNsb3RzLmZvckVhY2goKHNsb3QpID0+IHtcbiAgICAgICAgICBnb29nbGV0YWcuZGlzcGxheShzbG90KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRpc3BsYXlTbG90cy5zcGxpY2UoMCk7XG4gICAgICAgIGlmIChyZWZyZXNoU2xvdHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGdvb2dsZXRhZy5wdWJhZHMoKS5yZWZyZXNoKHJlZnJlc2hTbG90cyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRFdmVudExpc3RlbmVycygpIHtcbiAgICBnb29nbGV0YWcuY21kLnB1c2goKCkgPT4ge1xuICAgICAgY29uc3QgcHViYWRzID0gZ29vZ2xldGFnLnB1YmFkcygpO1xuICAgICAgcHViYWRzLmFkZEV2ZW50TGlzdGVuZXIoJ2ltcHJlc3Npb25WaWV3YWJsZScsIChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLiRldmVudHMubmV4dChuZXcgSW1wcmVzc2lvblZpZXdhYmxlRXZlbnQoZXZlbnQpKTtcbiAgICAgIH0pO1xuICAgICAgcHViYWRzLmFkZEV2ZW50TGlzdGVuZXIoJ3Nsb3RPbmxvYWQnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy4kZXZlbnRzLm5leHQobmV3IFNsb3RPbmxvYWRFdmVudChldmVudCkpO1xuICAgICAgfSk7XG4gICAgICBwdWJhZHMuYWRkRXZlbnRMaXN0ZW5lcignc2xvdFJlbmRlckVuZGVkJywgKGV2ZW50KSA9PiB7XG4gICAgICAgIHRoaXMuJGV2ZW50cy5uZXh0KG5ldyBTbG90UmVuZGVyRW5kZWRFdmVudChldmVudCkpO1xuICAgICAgfSk7XG4gICAgICBwdWJhZHMuYWRkRXZlbnRMaXN0ZW5lcignc2xvdFJlcXVlc3RlZCcsIChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLiRldmVudHMubmV4dChuZXcgU2xvdFJlcXVlc3RlZEV2ZW50KGV2ZW50KSk7XG4gICAgICB9KTtcbiAgICAgIHB1YmFkcy5hZGRFdmVudExpc3RlbmVyKCdzbG90UmVzcG9uc2VSZWNlaXZlZCcsIChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLiRldmVudHMubmV4dChuZXcgU2xvdFJlc3BvbnNlUmVjZWl2ZWQoZXZlbnQpKTtcbiAgICAgIH0pO1xuICAgICAgcHViYWRzLmFkZEV2ZW50TGlzdGVuZXIoJ3Nsb3RWaXNpYmlsaXR5Q2hhbmdlZCcsIChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLiRldmVudHMubmV4dChuZXcgU2xvdFZpc2liaWxpdHlDaGFuZ2VkRXZlbnQoZXZlbnQpKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgY2xlYXIoZWxlbWVudElkcz86IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgdGhpcy5jbWQoKCkgPT4ge1xuICAgICAgZ29vZ2xldGFnLnB1YmFkcygpLmNsZWFyKHRoaXMuZ2V0U2xvdHMoZWxlbWVudElkcykpO1xuICAgIH0pO1xuICB9XG5cbiAgY21kKGNhbGxiYWNrOiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIGdvb2dsZXRhZy5jbWQucHVzaChjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgZGVzdHJveVNsb3RzKGVsZW1lbnRJZHM/OiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIHRoaXMuY21kKCgpID0+IHtcbiAgICAgIGdvb2dsZXRhZy5kZXN0cm95U2xvdHModGhpcy5nZXRTbG90cyhlbGVtZW50SWRzKSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRTbG90cyhlbGVtZW50SWRzPzogc3RyaW5nW10pOiBnb29nbGV0YWcuU2xvdFtdIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgc2xvdHM6IGdvb2dsZXRhZy5TbG90W10gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIGlmIChnb29nbGV0YWcuYXBpUmVhZHkgJiYgZWxlbWVudElkcykge1xuICAgICAgICByZXR1cm4gZ29vZ2xldGFnXG4gICAgICAgICAgLnB1YmFkcygpXG4gICAgICAgICAgLmdldFNsb3RzKClcbiAgICAgICAgICAuZmlsdGVyKChzbG90KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZWxlbWVudElkcy5pbmRleE9mKHNsb3QuZ2V0U2xvdEVsZW1lbnRJZCgpKSAhPT0gLTE7XG4gICAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzbG90cztcbiAgfVxuXG4gIHJlZnJlc2goXG4gICAgZWxlbWVudElkcz86IHN0cmluZ1tdLFxuICAgIG9wdF9vcHRpb25zPzogeyBjaGFuZ2VDb3JyZWxhdG9yOiBib29sZWFuIH0sXG4gICk6IHZvaWQge1xuICAgIHRoaXMuY21kKCgpID0+IHtcbiAgICAgIGdvb2dsZXRhZy5wdWJhZHMoKS5yZWZyZXNoKHRoaXMuZ2V0U2xvdHMoZWxlbWVudElkcyksIG9wdF9vcHRpb25zKTtcbiAgICB9KTtcbiAgfVxuXG4gIHF1ZXVlKGV2ZW50OiBBY3Rpb24pIHtcbiAgICB0aGlzLiRxdWV1ZS5uZXh0KGV2ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBlbmQgU2NyaXB0IHRhZyB0byBwYXJlbnROb2RlXG4gICAqIEBwYXJhbSBvcHRpb25zXG4gICAqIEBwYXJhbSBwYXJlbnROb2RlIFRoZSBkZWZhdWx0IHNldHRpbmcgaXMgZG9jdW1lbnQuaGVhZFxuICAgKiBAcmV0dXJuc1xuICAgKi9cbiAgYXBwZW5kU2NyaXB0KFxuICAgIG9wdGlvbnM6IFNjcmlwdE9wdGlvbnMsXG4gICAgcGFyZW50Tm9kZT86IEVsZW1lbnQsXG4gICk6IEhUTUxTY3JpcHRFbGVtZW50IHtcbiAgICBwYXJlbnROb2RlID0gcGFyZW50Tm9kZSB8fCB0aGlzLmRvY3VtZW50LmhlYWQ7XG4gICAgY29uc3Qgb2xkU2NyaXB0ID0gb3B0aW9ucy5pZFxuICAgICAgPyBwYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3IoJyMnICsgb3B0aW9ucy5pZClcbiAgICAgIDogbnVsbDtcbiAgICBjb25zdCBzY3JpcHQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIE9iamVjdC5hc3NpZ24oc2NyaXB0LCBvcHRpb25zLCB7XG4gICAgICB0eXBlOiAndGV4dC9qYXZhc2NyaXB0JyxcbiAgICB9KTtcbiAgICBpZiAob2xkU2NyaXB0KSB7XG4gICAgICBwYXJlbnROb2RlLnJlcGxhY2VDaGlsZChzY3JpcHQsIG9sZFNjcmlwdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXBwZW5kVGV4dCgnXFxuJywgcGFyZW50Tm9kZSk7XG4gICAgICBwYXJlbnROb2RlLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgICB0aGlzLmFwcGVuZFRleHQoJ1xcbicsIHBhcmVudE5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gc2NyaXB0O1xuICB9XG5cbiAgYXBwZW5kVGV4dChkYXRhOiBzdHJpbmcsIHBhcmVudE5vZGU/OiBFbGVtZW50KTogVGV4dCB7XG4gICAgcGFyZW50Tm9kZSA9IHBhcmVudE5vZGUgfHwgdGhpcy5kb2N1bWVudC5oZWFkO1xuICAgIGNvbnN0IHRleHQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGRhdGEpO1xuICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQodGV4dCk7XG4gICAgcmV0dXJuIHRleHQ7XG4gIH1cbn1cbiJdfQ==
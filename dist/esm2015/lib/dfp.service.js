import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { Subject, timer } from 'rxjs';
import { buffer, switchMap } from 'rxjs/operators';
import { GPT_SOURCE, DELAY_TIME } from './consts';
import { ImpressionViewableEvent, SlotOnloadEvent, SlotRenderEndedEvent, SlotRequestedEvent, SlotResponseReceived, SlotVisibilityChangedEvent, } from './events';
import { DisplaySlot, RefreshSlot } from './actions';
import * as i0 from "@angular/core";
export class DfpService {
    constructor(platformId, document) {
        this.platformId = platformId;
        this.document = document;
        this.$singleRequest = new Subject();
        this.$events = new Subject();
        if (isPlatformBrowser(this.platformId)) {
            this.init();
        }
    }
    get events() {
        return this.$events.asObservable();
    }
    init() {
        // GPT
        if (!window.googletag) {
            this.appendScript({ async: true, src: GPT_SOURCE });
            window.googletag = window.googletag || { cmd: [] };
        }
        // Single Request Queue
        this.$singleRequest
            .pipe(buffer(this.$singleRequest.pipe(switchMap(() => timer(DELAY_TIME * 2)))))
            .subscribe((acts) => {
            acts.forEach((act) => {
                if (act instanceof DisplaySlot) {
                    googletag.display(act.slot);
                }
                else if (act instanceof RefreshSlot) {
                    googletag.pubads().refresh([act.slot], { changeCorrelator: false });
                }
            });
        });
        // Event Listeners
        googletag.cmd.push(() => {
            const pubads = googletag.pubads();
            pubads.addEventListener('impressionViewable', (event) => {
                this.$events.next(new ImpressionViewableEvent(event));
            });
            pubads.addEventListener('slotOnload', (event) => {
                this.$events.next(new SlotOnloadEvent(event));
            });
            pubads.addEventListener('slotRenderEnded', (event) => {
                this.$events.next(new SlotRenderEndedEvent(event));
            });
            pubads.addEventListener('slotRequested', (event) => {
                this.$events.next(new SlotRequestedEvent(event));
            });
            pubads.addEventListener('slotResponseReceived', (event) => {
                this.$events.next(new SlotResponseReceived(event));
            });
            pubads.addEventListener('slotVisibilityChanged', (event) => {
                this.$events.next(new SlotVisibilityChangedEvent(event));
            });
        });
    }
    define(ad) {
        let slot;
        let id = ad.id || '';
        if (id) {
            const slotExists = this.getSlot(id);
            if ((slotExists === null || slotExists === void 0 ? void 0 : slotExists.getAdUnitPath()) === ad.unitPath) {
                slot = slotExists;
            }
            else if (slotExists) {
                this.destroy(slotExists);
            }
        }
        if (!slot) {
            if (ad.size) {
                slot = googletag.defineSlot(ad.unitPath, ad.size, id);
            }
            else {
                slot = googletag.defineOutOfPageSlot(ad.unitPath, id);
            }
            if (!slot) {
                return;
            }
        }
        if (ad.size && ad.content) {
            slot.addService(googletag.content());
            googletag.enableServices();
            googletag.content().setContent(slot, ad.content);
        }
        else {
            if (ad.sizeMapping) {
                slot.defineSizeMapping(ad.sizeMapping);
            }
            slot.clearCategoryExclusions();
            if (ad.categoryExclusion) {
                if (ad.categoryExclusion instanceof Array) {
                    ad.categoryExclusion.forEach((cat) => slot === null || slot === void 0 ? void 0 : slot.setCategoryExclusion(cat));
                }
                else {
                    slot.setCategoryExclusion(ad.categoryExclusion);
                }
            }
            if (typeof ad.forceSafeFrame === 'boolean') {
                slot.setForceSafeFrame(ad.forceSafeFrame);
            }
            if (ad.safeFrameConfig) {
                slot.setSafeFrameConfig(ad.safeFrameConfig);
            }
            slot.clearTargeting();
            if (ad.targeting) {
                slot.updateTargetingFromMap(ad.targeting);
            }
            if (ad.collapseEmptyDiv instanceof Array) {
                slot.setCollapseEmptyDiv(ad.collapseEmptyDiv[0], ad.collapseEmptyDiv[1]);
            }
            else if (typeof ad.collapseEmptyDiv === 'boolean') {
                slot.setCollapseEmptyDiv(ad.collapseEmptyDiv);
            }
            if (ad.clickUrl) {
                slot.setClickUrl(ad.clickUrl);
            }
            if (ad.adsense) {
                for (const key in ad.adsense) {
                    slot.set(key, ad.adsense[key]);
                }
            }
            slot.addService(googletag.pubads());
            googletag.enableServices();
        }
        return slot;
    }
    display(slot) {
        if (googletag.pubads().isSRA()) {
            this.$singleRequest.next(new DisplaySlot(slot));
        }
        else {
            googletag.display(slot);
        }
    }
    refresh(slot) {
        if (googletag.pubads().isSRA()) {
            this.$singleRequest.next(new RefreshSlot(slot));
        }
        else {
            googletag.pubads().refresh([slot]);
        }
    }
    destroy(slot) {
        googletag.destroySlots([slot]);
    }
    /**
     * Get the slot by element id
     * @param elementId the slot element id
     * @returns
     */
    getSlot(elementId) {
        return this.getSlots().find((slot) => elementId === slot.getSlotElementId());
    }
    /**
     * Get the list of slots associated with this service.
     * @param elementIds the slot element id array.
     * @returns
     */
    getSlots(elementIds) {
        let slots = googletag.pubads().getSlots();
        if (typeof elementIds !== 'undefined') {
            slots = slots.filter((slot) => elementIds.indexOf(slot.getSlotElementId()) != -1);
        }
        return slots;
    }
    /**
     * Use googletag.cmd.push() to execute the callback function.
     * @param callback
     */
    cmd(callback) {
        if (isPlatformBrowser(this.platformId)) {
            googletag.cmd.push(callback);
        }
    }
    appendScript(options, parentNode) {
        parentNode = parentNode || this.document.head;
        const oldScript = options.id
            ? parentNode.querySelector('#' + options.id)
            : null;
        const script = this.document.createElement('script');
        Object.assign(script, options, { type: 'text/javascript' });
        if (oldScript) {
            parentNode.replaceChild(script, oldScript);
        }
        else {
            this.appendText('\n', parentNode);
            parentNode.appendChild(script);
            this.appendText('\n', parentNode);
        }
        return script;
    }
    appendText(data, parentNode) {
        parentNode = parentNode || this.document.head;
        const text = this.document.createTextNode(data);
        parentNode.appendChild(text);
        return text;
    }
}
DfpService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.1.1", ngImport: i0, type: DfpService, deps: [{ token: PLATFORM_ID }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
DfpService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.1.1", ngImport: i0, type: DfpService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.1.1", ngImport: i0, type: DfpService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGZwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2RmcC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFaEUsT0FBTyxFQUFjLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsRCxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLGVBQWUsRUFDZixvQkFBb0IsRUFDcEIsa0JBQWtCLEVBQ2xCLG9CQUFvQixFQUNwQiwwQkFBMEIsR0FDM0IsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxFQUFXLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7O0FBTTlELE1BQU0sT0FBTyxVQUFVO0lBT3JCLFlBQytCLFVBQW1DLEVBQ3RDLFFBQWtCO1FBRGYsZUFBVSxHQUFWLFVBQVUsQ0FBeUI7UUFDdEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQVJ0QyxtQkFBYyxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDeEMsWUFBTyxHQUFHLElBQUksT0FBTyxFQUFTLENBQUM7UUFTckMsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDdEMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0lBWEQsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFXTyxJQUFJ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QUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JELE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxpQkFBaUIsRUFBRSxDQUFDLENBQUM7UUFDNUQsSUFBSSxTQUFTLEVBQUU7WUFDYixVQUFVLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztTQUM1QzthQUFNO1lBQ0wsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDbEMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztTQUNuQztRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxVQUFVLENBQUMsSUFBWSxFQUFFLFVBQW9CO1FBQzNDLFVBQVUsR0FBRyxVQUFVLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDOUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEQsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7O3VHQWxPVSxVQUFVLGtCQVFYLFdBQVcsYUFDWCxRQUFROzJHQVRQLFVBQVUsY0FGVCxNQUFNOzJGQUVQLFVBQVU7a0JBSHRCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFTSSxNQUFNOzJCQUFDLFdBQVc7OEJBQ2lCLFFBQVE7MEJBQTNDLE1BQU07MkJBQUMsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERPQ1VNRU5ULCBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBidWZmZXIsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgR1BUX1NPVVJDRSwgREVMQVlfVElNRSB9IGZyb20gJy4vY29uc3RzJztcbmltcG9ydCB7XG4gIEV2ZW50LFxuICBJbXByZXNzaW9uVmlld2FibGVFdmVudCxcbiAgU2xvdE9ubG9hZEV2ZW50LFxuICBTbG90UmVuZGVyRW5kZWRFdmVudCxcbiAgU2xvdFJlcXVlc3RlZEV2ZW50LFxuICBTbG90UmVzcG9uc2VSZWNlaXZlZCxcbiAgU2xvdFZpc2liaWxpdHlDaGFuZ2VkRXZlbnQsXG59IGZyb20gJy4vZXZlbnRzJztcbmltcG9ydCB7IFJlcXVlc3QsIERpc3BsYXlTbG90LCBSZWZyZXNoU2xvdCB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBTY3JpcHRPcHRpb25zLCBEZnBBZCB9IGZyb20gJy4vdHlwZXMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgRGZwU2VydmljZSB7XG4gIHByaXZhdGUgJHNpbmdsZVJlcXVlc3QgPSBuZXcgU3ViamVjdDxSZXF1ZXN0PigpO1xuICBwcml2YXRlICRldmVudHMgPSBuZXcgU3ViamVjdDxFdmVudD4oKTtcbiAgZ2V0IGV2ZW50cygpOiBPYnNlcnZhYmxlPEV2ZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuJGV2ZW50cy5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQsXG4gICkge1xuICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICB0aGlzLmluaXQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXQoKTogdm9pZCB7XG4gICAgLy8gR1BUXG4gICAgaWYgKCF3aW5kb3cuZ29vZ2xldGFnKSB7XG4gICAgICB0aGlzLmFwcGVuZFNjcmlwdCh7IGFzeW5jOiB0cnVlLCBzcmM6IEdQVF9TT1VSQ0UgfSk7XG4gICAgICB3aW5kb3cuZ29vZ2xldGFnID0gd2luZG93Lmdvb2dsZXRhZyB8fCB7IGNtZDogW10gfTtcbiAgICB9XG4gICAgLy8gU2luZ2xlIFJlcXVlc3QgUXVldWVcbiAgICB0aGlzLiRzaW5nbGVSZXF1ZXN0XG4gICAgICAucGlwZShcbiAgICAgICAgYnVmZmVyKFxuICAgICAgICAgIHRoaXMuJHNpbmdsZVJlcXVlc3QucGlwZShzd2l0Y2hNYXAoKCkgPT4gdGltZXIoREVMQVlfVElNRSAqIDIpKSksXG4gICAgICAgICksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChhY3RzKSA9PiB7XG4gICAgICAgIGFjdHMuZm9yRWFjaCgoYWN0KSA9PiB7XG4gICAgICAgICAgaWYgKGFjdCBpbnN0YW5jZW9mIERpc3BsYXlTbG90KSB7XG4gICAgICAgICAgICBnb29nbGV0YWcuZGlzcGxheShhY3Quc2xvdCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChhY3QgaW5zdGFuY2VvZiBSZWZyZXNoU2xvdCkge1xuICAgICAgICAgICAgZ29vZ2xldGFnLnB1YmFkcygpLnJlZnJlc2goW2FjdC5zbG90XSwgeyBjaGFuZ2VDb3JyZWxhdG9yOiBmYWxzZSB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgLy8gRXZlbnQgTGlzdGVuZXJzXG4gICAgZ29vZ2xldGFnLmNtZC5wdXNoKCgpID0+IHtcbiAgICAgIGNvbnN0IHB1YmFkcyA9IGdvb2dsZXRhZy5wdWJhZHMoKTtcbiAgICAgIHB1YmFkcy5hZGRFdmVudExpc3RlbmVyKCdpbXByZXNzaW9uVmlld2FibGUnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy4kZXZlbnRzLm5leHQobmV3IEltcHJlc3Npb25WaWV3YWJsZUV2ZW50KGV2ZW50KSk7XG4gICAgICB9KTtcbiAgICAgIHB1YmFkcy5hZGRFdmVudExpc3RlbmVyKCdzbG90T25sb2FkJywgKGV2ZW50KSA9PiB7XG4gICAgICAgIHRoaXMuJGV2ZW50cy5uZXh0KG5ldyBTbG90T25sb2FkRXZlbnQoZXZlbnQpKTtcbiAgICAgIH0pO1xuICAgICAgcHViYWRzLmFkZEV2ZW50TGlzdGVuZXIoJ3Nsb3RSZW5kZXJFbmRlZCcsIChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLiRldmVudHMubmV4dChuZXcgU2xvdFJlbmRlckVuZGVkRXZlbnQoZXZlbnQpKTtcbiAgICAgIH0pO1xuICAgICAgcHViYWRzLmFkZEV2ZW50TGlzdGVuZXIoJ3Nsb3RSZXF1ZXN0ZWQnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy4kZXZlbnRzLm5leHQobmV3IFNsb3RSZXF1ZXN0ZWRFdmVudChldmVudCkpO1xuICAgICAgfSk7XG4gICAgICBwdWJhZHMuYWRkRXZlbnRMaXN0ZW5lcignc2xvdFJlc3BvbnNlUmVjZWl2ZWQnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy4kZXZlbnRzLm5leHQobmV3IFNsb3RSZXNwb25zZVJlY2VpdmVkKGV2ZW50KSk7XG4gICAgICB9KTtcbiAgICAgIHB1YmFkcy5hZGRFdmVudExpc3RlbmVyKCdzbG90VmlzaWJpbGl0eUNoYW5nZWQnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy4kZXZlbnRzLm5leHQobmV3IFNsb3RWaXNpYmlsaXR5Q2hhbmdlZEV2ZW50KGV2ZW50KSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlZmluZShhZDogRGZwQWQpOiBnb29nbGV0YWcuU2xvdCB8IHVuZGVmaW5lZCB7XG4gICAgbGV0IHNsb3Q6IGdvb2dsZXRhZy5TbG90IHwgbnVsbCB8IHVuZGVmaW5lZDtcbiAgICBsZXQgaWQgPSBhZC5pZCB8fCAnJztcblxuICAgIGlmIChpZCkge1xuICAgICAgY29uc3Qgc2xvdEV4aXN0cyA9IHRoaXMuZ2V0U2xvdChpZCk7XG4gICAgICBpZiAoc2xvdEV4aXN0cz8uZ2V0QWRVbml0UGF0aCgpID09PSBhZC51bml0UGF0aCkge1xuICAgICAgICBzbG90ID0gc2xvdEV4aXN0cztcbiAgICAgIH0gZWxzZSBpZiAoc2xvdEV4aXN0cykge1xuICAgICAgICB0aGlzLmRlc3Ryb3koc2xvdEV4aXN0cyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFzbG90KSB7XG4gICAgICBpZiAoYWQuc2l6ZSkge1xuICAgICAgICBzbG90ID0gZ29vZ2xldGFnLmRlZmluZVNsb3QoYWQudW5pdFBhdGgsIGFkLnNpemUsIGlkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNsb3QgPSBnb29nbGV0YWcuZGVmaW5lT3V0T2ZQYWdlU2xvdChhZC51bml0UGF0aCwgaWQpO1xuICAgICAgfVxuICAgICAgaWYgKCFzbG90KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoYWQuc2l6ZSAmJiBhZC5jb250ZW50KSB7XG4gICAgICBzbG90LmFkZFNlcnZpY2UoZ29vZ2xldGFnLmNvbnRlbnQoKSk7XG4gICAgICBnb29nbGV0YWcuZW5hYmxlU2VydmljZXMoKTtcbiAgICAgIGdvb2dsZXRhZy5jb250ZW50KCkuc2V0Q29udGVudChzbG90LCBhZC5jb250ZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGFkLnNpemVNYXBwaW5nKSB7XG4gICAgICAgIHNsb3QuZGVmaW5lU2l6ZU1hcHBpbmcoYWQuc2l6ZU1hcHBpbmcpO1xuICAgICAgfVxuXG4gICAgICBzbG90LmNsZWFyQ2F0ZWdvcnlFeGNsdXNpb25zKCk7XG4gICAgICBpZiAoYWQuY2F0ZWdvcnlFeGNsdXNpb24pIHtcbiAgICAgICAgaWYgKGFkLmNhdGVnb3J5RXhjbHVzaW9uIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICBhZC5jYXRlZ29yeUV4Y2x1c2lvbi5mb3JFYWNoKChjYXQpID0+XG4gICAgICAgICAgICBzbG90Py5zZXRDYXRlZ29yeUV4Y2x1c2lvbihjYXQpLFxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2xvdC5zZXRDYXRlZ29yeUV4Y2x1c2lvbihhZC5jYXRlZ29yeUV4Y2x1c2lvbik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiBhZC5mb3JjZVNhZmVGcmFtZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgIHNsb3Quc2V0Rm9yY2VTYWZlRnJhbWUoYWQuZm9yY2VTYWZlRnJhbWUpO1xuICAgICAgfVxuXG4gICAgICBpZiAoYWQuc2FmZUZyYW1lQ29uZmlnKSB7XG4gICAgICAgIHNsb3Quc2V0U2FmZUZyYW1lQ29uZmlnKGFkLnNhZmVGcmFtZUNvbmZpZyk7XG4gICAgICB9XG5cbiAgICAgIHNsb3QuY2xlYXJUYXJnZXRpbmcoKTtcbiAgICAgIGlmIChhZC50YXJnZXRpbmcpIHtcbiAgICAgICAgc2xvdC51cGRhdGVUYXJnZXRpbmdGcm9tTWFwKGFkLnRhcmdldGluZyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChhZC5jb2xsYXBzZUVtcHR5RGl2IGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgc2xvdC5zZXRDb2xsYXBzZUVtcHR5RGl2KFxuICAgICAgICAgIGFkLmNvbGxhcHNlRW1wdHlEaXZbMF0sXG4gICAgICAgICAgYWQuY29sbGFwc2VFbXB0eURpdlsxXSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFkLmNvbGxhcHNlRW1wdHlEaXYgPT09ICdib29sZWFuJykge1xuICAgICAgICBzbG90LnNldENvbGxhcHNlRW1wdHlEaXYoYWQuY29sbGFwc2VFbXB0eURpdik7XG4gICAgICB9XG5cbiAgICAgIGlmIChhZC5jbGlja1VybCkge1xuICAgICAgICBzbG90LnNldENsaWNrVXJsKGFkLmNsaWNrVXJsKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFkLmFkc2Vuc2UpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gYWQuYWRzZW5zZSkge1xuICAgICAgICAgIHNsb3Quc2V0KGtleSwgYWQuYWRzZW5zZVtrZXldKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBzbG90LmFkZFNlcnZpY2UoZ29vZ2xldGFnLnB1YmFkcygpKTtcbiAgICAgIGdvb2dsZXRhZy5lbmFibGVTZXJ2aWNlcygpO1xuICAgIH1cblxuICAgIHJldHVybiBzbG90O1xuICB9XG5cbiAgZGlzcGxheShzbG90OiBnb29nbGV0YWcuU2xvdCk6IHZvaWQge1xuICAgIGlmIChnb29nbGV0YWcucHViYWRzKCkuaXNTUkEoKSkge1xuICAgICAgdGhpcy4kc2luZ2xlUmVxdWVzdC5uZXh0KG5ldyBEaXNwbGF5U2xvdChzbG90KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGdvb2dsZXRhZy5kaXNwbGF5KHNsb3QpO1xuICAgIH1cbiAgfVxuXG4gIHJlZnJlc2goc2xvdDogZ29vZ2xldGFnLlNsb3QpOiB2b2lkIHtcbiAgICBpZiAoZ29vZ2xldGFnLnB1YmFkcygpLmlzU1JBKCkpIHtcbiAgICAgIHRoaXMuJHNpbmdsZVJlcXVlc3QubmV4dChuZXcgUmVmcmVzaFNsb3Qoc2xvdCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBnb29nbGV0YWcucHViYWRzKCkucmVmcmVzaChbc2xvdF0pO1xuICAgIH1cbiAgfVxuXG4gIGRlc3Ryb3koc2xvdDogZ29vZ2xldGFnLlNsb3QpOiB2b2lkIHtcbiAgICBnb29nbGV0YWcuZGVzdHJveVNsb3RzKFtzbG90XSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBzbG90IGJ5IGVsZW1lbnQgaWRcbiAgICogQHBhcmFtIGVsZW1lbnRJZCB0aGUgc2xvdCBlbGVtZW50IGlkXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBnZXRTbG90KGVsZW1lbnRJZDogc3RyaW5nKTogZ29vZ2xldGFnLlNsb3QgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmdldFNsb3RzKCkuZmluZChcbiAgICAgIChzbG90KSA9PiBlbGVtZW50SWQgPT09IHNsb3QuZ2V0U2xvdEVsZW1lbnRJZCgpLFxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBsaXN0IG9mIHNsb3RzIGFzc29jaWF0ZWQgd2l0aCB0aGlzIHNlcnZpY2UuXG4gICAqIEBwYXJhbSBlbGVtZW50SWRzIHRoZSBzbG90IGVsZW1lbnQgaWQgYXJyYXkuXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBnZXRTbG90cyhlbGVtZW50SWRzPzogc3RyaW5nW10pOiBnb29nbGV0YWcuU2xvdFtdIHtcbiAgICBsZXQgc2xvdHM6IGdvb2dsZXRhZy5TbG90W10gPSBnb29nbGV0YWcucHViYWRzKCkuZ2V0U2xvdHMoKTtcbiAgICBpZiAodHlwZW9mIGVsZW1lbnRJZHMgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBzbG90cyA9IHNsb3RzLmZpbHRlcihcbiAgICAgICAgKHNsb3QpID0+IGVsZW1lbnRJZHMuaW5kZXhPZihzbG90LmdldFNsb3RFbGVtZW50SWQoKSkgIT0gLTEsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gc2xvdHM7XG4gIH1cblxuICAvKipcbiAgICogVXNlIGdvb2dsZXRhZy5jbWQucHVzaCgpIHRvIGV4ZWN1dGUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uLlxuICAgKiBAcGFyYW0gY2FsbGJhY2tcbiAgICovXG4gIGNtZChjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICBnb29nbGV0YWcuY21kLnB1c2goY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIGFwcGVuZFNjcmlwdChcbiAgICBvcHRpb25zOiBTY3JpcHRPcHRpb25zLFxuICAgIHBhcmVudE5vZGU/OiBFbGVtZW50LFxuICApOiBIVE1MU2NyaXB0RWxlbWVudCB7XG4gICAgcGFyZW50Tm9kZSA9IHBhcmVudE5vZGUgfHwgdGhpcy5kb2N1bWVudC5oZWFkO1xuICAgIGNvbnN0IG9sZFNjcmlwdCA9IG9wdGlvbnMuaWRcbiAgICAgID8gcGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKCcjJyArIG9wdGlvbnMuaWQpXG4gICAgICA6IG51bGw7XG4gICAgY29uc3Qgc2NyaXB0ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICBPYmplY3QuYXNzaWduKHNjcmlwdCwgb3B0aW9ucywgeyB0eXBlOiAndGV4dC9qYXZhc2NyaXB0JyB9KTtcbiAgICBpZiAob2xkU2NyaXB0KSB7XG4gICAgICBwYXJlbnROb2RlLnJlcGxhY2VDaGlsZChzY3JpcHQsIG9sZFNjcmlwdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYXBwZW5kVGV4dCgnXFxuJywgcGFyZW50Tm9kZSk7XG4gICAgICBwYXJlbnROb2RlLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgICB0aGlzLmFwcGVuZFRleHQoJ1xcbicsIHBhcmVudE5vZGUpO1xuICAgIH1cbiAgICByZXR1cm4gc2NyaXB0O1xuICB9XG5cbiAgYXBwZW5kVGV4dChkYXRhOiBzdHJpbmcsIHBhcmVudE5vZGU/OiBFbGVtZW50KTogVGV4dCB7XG4gICAgcGFyZW50Tm9kZSA9IHBhcmVudE5vZGUgfHwgdGhpcy5kb2N1bWVudC5oZWFkO1xuICAgIGNvbnN0IHRleHQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGRhdGEpO1xuICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQodGV4dCk7XG4gICAgcmV0dXJuIHRleHQ7XG4gIH1cbn1cbiJdfQ==